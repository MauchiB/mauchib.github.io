<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jarvis Botz Web</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: var(--tg-theme-bg-color, #f0f2f5);
            color: var(--tg-theme-text-color, #222);
        }
        .chat-card {
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            transition: all 0.2s;
        }
        .chat-card:active {
            background-color: var(--tg-theme-hint-color, #e5e7eb);
            transform: scale(0.98);
        }
        .accent-text { color: var(--tg-theme-button-color, #3390ec); }
        .hint-text { color: var(--tg-theme-hint-color, #8e8e93); }
        .badge { background-color: var(--tg-theme-button-color, #3390ec); color: var(--tg-theme-button-text-color, #fff); }
    </style>
</head>
<body class="p-4 font-sans antialiased">

    <header class="mb-6 flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold">–ß–∞—Ç—ã</h1>
            <p class="hint-text text-sm">–¢–≤–æ–∏ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—ã</p>
        </div>
        <div id="avatar" class="w-12 h-12 rounded-full border-2 border-blue-500 overflow-hidden bg-gray-200">
            <img id="user-photo" src="https://ui-avatars.com/api/?name=User" alt="Avatar">
        </div>
    </header>

    <div id="chat-list" class="space-y-3">
        </div>

    <div id="empty-state" class="hidden text-center py-20">
        <p class="hint-text">–£ —Ç–µ–±—è –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</p>
    </div>

    <script>
    const tg = window.Telegram.WebApp;
    console.log("Telegram WebApp object:", tg);
    console.log("Init Data:", tg.initData);
    tg.ready();
    tg.expand();

    // 1. –£–∫–∞–∑—ã–≤–∞–µ–º –∞–¥—Ä–µ—Å —Ç–≤–æ–µ–≥–æ FastAPI —Å–µ—Ä–≤–µ—Ä–∞
    // –ï—Å–ª–∏ —Ç–µ—Å—Ç–∏—Ä—É–µ—à—å –ª–æ–∫–∞–ª—å–Ω–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π Ngrok (—Å–º. –Ω–∏–∂–µ), 
    // —Ç–∞–∫ –∫–∞–∫ GitHub (https) –Ω–µ —Å–º–æ–∂–µ—Ç —Å–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ localhost (http)
    const API_URL_POST = "https://w6949pzb-8000.euw.devtunnels.ms/api/v1/select-chat"; // –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ç–≤–æ–π URL
    const API_URL_GET = "https://w6949pzb-8000.euw.devtunnels.ms/api/v1/chats"; // –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ç–≤–æ–π URL

    async function loadChats() {
        try {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            const container = document.getElementById('chat-list');
            container.innerHTML = '<p class="text-center hint-text py-10">–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</p>';

            console.log("–ü–æ–ª–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ initData:", tg.initData);

            // 2. –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ FastAPI
            const response = await fetch(API_URL_GET, {
                method: "GET",
                headers: {
                    // –¢–æ—Ç —Å–∞–º—ã–π "–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–æ–Ω–≤–µ—Ä—Ç" –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                    "Authorization": `tma ${tg.initData}`
                }
            });

            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');

            const data = await response.json();
            
            // –ï—Å–ª–∏ –ø—Ä–∏—à–µ–ª –æ–±—ä–µ–∫—Ç —Ç–∏–ø–∞ {"chats": [...]}, –±–µ—Ä–µ–º –º–∞—Å—Å–∏–≤
            const chats = data.chats || data; 

            if (chats.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                container.innerHTML = '';
            } else {
                document.getElementById('empty-state').classList.add('hidden');
                renderChats(chats);
            }

        } catch (error) {
            console.error("–û—à–∏–±–∫–∞:", error);
            document.getElementById('chat-list').innerHTML = 
                `<p class="text-center text-red-500 py-10">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–∞—Ç—ã</p>`;
        }
    }

    function renderChats(chats) {
        const container = document.getElementById('chat-list');
        container.innerHTML = '';

        chats.forEach(chat => {
            const card = document.createElement('div');
            card.className = 'chat-card flex items-center p-4 rounded-2xl shadow-sm cursor-pointer mb-3';
            card.onclick = () => selectChat(chat.id);

            // –ü–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–æ–¥ –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏—Å—ã–ª–∞–µ—Ç —Ç–≤–æ–π FastAPI
            card.innerHTML = `
                <div class="text-3xl mr-4 bg-gray-100 w-12 h-12 flex items-center justify-center rounded-xl">
                    ${chat.icon || 'ü§ñ'}
                </div>
                <div class="flex-1 overflow-hidden">
                    <div class="flex justify-between items-center mb-1">
                        <h3 class="font-semibold truncate">${chat.name}</h3>
                        <span class="hint-text text-xs">${chat.time || ''}</span>
                    </div>
                    <p class="hint-text text-sm truncate">${chat.lastMsg || chat.lastMessage || ''}</p>
                </div>
                ${chat.unread > 0 ? `<span class="badge ml-3 px-2 py-0.5 rounded-full text-[10px] font-bold">${chat.messages}</span>` : ''}
            `;
            container.appendChild(card);
        });
    }

    function selectChat(id) {
        tg.HapticFeedback.impactOccurred('medium');

        fetch(`${API_URL_POST}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                session_id: id, 
                user_id: tg.initDataUnsafe.user.id 
            })
            
        }).then(() => {
            tg.close(); 
        });
    }

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if (tg.initDataUnsafe.user) {
        const user = tg.initDataUnsafe.user;
        document.getElementById('user-photo').src = user.photo_url || `https://ui-avatars.com/api/?name=${user.first_name}`;
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadChats();
</script>
</body>
</html>
